<!-- Copyright (c) Microsoft Corporation.
     Licensed under the MIT License. -->

<!-- Common properties used by most of the projects.
     This ensures we target the same versions and have the right security settings everywhere.
     Some properties may need to be overridden in specific projects -->
<Project>
  <PropertyGroup>
    <IsExternalProject Condition=" '$(MSBuildProjectName)' == 'cpprestsdk' ">true</IsExternalProject>
    <IsExternalProject Condition=" '$(MSBuildProjectName)' == 'Detours' ">true</IsExternalProject>
    <IsExternalProject Condition=" '$(MSBuildProjectName)' == 'JsonCppLib' ">true</IsExternalProject>
    <IsExternalProject Condition=" '$(MSBuildProjectName)' == 'PureLib' ">true</IsExternalProject>
    <IsExternalProject Condition=" '$(MSBuildProjectName)' == 'UndockedRegFreeWinRT' ">true</IsExternalProject>
    <IsExternalProject Condition=" '$(MSBuildProjectName)' == 'YamlCppLib' ">true</IsExternalProject>
  </PropertyGroup>

  <Choose>
    <!-- Don't report warnings from external projects -->
    <When Condition=" '$(IsExternalProject)' == 'true'">
      <PropertyGroup>
        <RunCodeAnalysis>false</RunCodeAnalysis>
      </PropertyGroup>
      <ItemDefinitionGroup>
        <ClCompile>
          <WarningLevel>TurnOffAllWarnings</WarningLevel>
          <TreatWarningAsError>false</TreatWarningAsError>
        </ClCompile>
      </ItemDefinitionGroup>
    </When>

    <!-- Most of the properties here are for C++, so we exclude other project types. -->
    <When Condition=" '$(MSBuildProjectExtension)' == '.wapproj' "/>

    <When Condition=" '$(MSBuildProjectExtension)' == '.csproj' ">
      <PropertyGroup>
        <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
      </PropertyGroup>
    </When>

    <Otherwise>
      <PropertyGroup Label="Globals">
        <CppWinRTOptimized>true</CppWinRTOptimized>
        <CppWinRTRootNamespaceAutoMerge>true</CppWinRTRootNamespaceAutoMerge>
        <MinimalCoreWin>true</MinimalCoreWin>
        <Keyword>Win32Proj</Keyword>
        <WindowsTargetPlatformVersion>10.0.22000.0</WindowsTargetPlatformVersion>
        <WindowsTargetPlatformMinVersion>10.0.17763.0</WindowsTargetPlatformMinVersion>
        <WindowsSDKDesktopARMSupport>true</WindowsSDKDesktopARMSupport>
        <WindowsSDKDesktopARM64Support>true</WindowsSDKDesktopARM64Support>
        <!-- We need the SolutionDir for the OutDir to be set correctly.
             It is not defined for cases when we don't use the .sln but specific projects, like some nuget restore. -->
        <SolutionDir Condition=" '$(SolutionDir)' == '' ">$(MSBuildThisFileDirectory)</SolutionDir>
      </PropertyGroup>

      <PropertyGroup Label="Configuration">
        <ConfigurationType>StaticLibrary</ConfigurationType>
        <PlatformToolset>v140</PlatformToolset>
        <PlatformToolset Condition="'$(VisualStudioVersion)' == '15.0'">v141</PlatformToolset>
        <PlatformToolset Condition="'$(VisualStudioVersion)' == '16.0'">v142</PlatformToolset>
        <PlatformToolset Condition="'$(VisualStudioVersion)' == '17.0'">v143</PlatformToolset>
        <CharacterSet>Unicode</CharacterSet>
      </PropertyGroup>
      <PropertyGroup Label="Configuration" Condition=" '$(Configuration)' == 'Release' Or '$(Configuration)' == 'ReleaseStatic' ">
        <UseDebugLibraries>false</UseDebugLibraries>
        <WholeProgramOptimization>true</WholeProgramOptimization>
        <LinkIncremental>false</LinkIncremental>
        <RunCodeAnalysis>false</RunCodeAnalysis>
        <!-- SpectreMitigation is required by BinSkim -->
        <!-- <SpectreMitigation>Spectre</SpectreMitigation> -->
      </PropertyGroup>
      <PropertyGroup Label="Configuration" Condition=" '$(Configuration)' == 'Debug' ">
        <UseDebugLibraries>true</UseDebugLibraries>
        <LinkIncremental>true</LinkIncremental>
        <RunCodeAnalysis>true</RunCodeAnalysis>
        <CodeAnalysisRuleSet>$(SolutionDir)CodeAnalysis.ruleset</CodeAnalysisRuleSet>
        <CodeAnalysisTreatWarningsAsErrors>true</CodeAnalysisTreatWarningsAsErrors>
      </PropertyGroup>
      <PropertyGroup  Label="Configuration" Condition=" '$(Configuration)' == 'Fuzzing' ">
        <UseDebugLibraries>false</UseDebugLibraries>
        <WholeProgramOptimization>false</WholeProgramOptimization>
        <LinkIncremental>false</LinkIncremental>
        <!-- Enable address sanitizer -->
        <EnableASAN>true</EnableASAN>
      </PropertyGroup>

      <PropertyGroup Condition=" '$(Platform)' == 'Win32' ">
        <OutDir>$(SolutionDir)x86\$(Configuration)\$(MSBuildProjectName)\</OutDir>
      </PropertyGroup>
      <PropertyGroup Condition=" '$(Platform)' != 'Win32' ">
        <OutDir>$(SolutionDir)$(Platform)\$(Configuration)\$(MSBuildProjectName)\</OutDir>
      </PropertyGroup>

      <ItemDefinitionGroup>
        <ClCompile>
          <PrecompiledHeader Condition="Exists('pch.h')">Use</PrecompiledHeader>
          <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
          <PrecompiledHeaderOutputFile>$(IntDir)pch.pch</PrecompiledHeaderOutputFile>
          <!-- Macros used in pipelines to control build behavior -->
          <PreprocessorDefinitions Condition=" '$(WingetDisableTestHooks)' == 'true' ">AICLI_DISABLE_TEST_HOOKS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <PreprocessorDefinitions Condition=" '$(WingetDisableExperimentalFeatures)' == 'true' ">WINGET_DISABLE_EXPERIMENTAL_FEATURES;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <PreprocessorDefinitions Condition=" '$(WingetEnableReleaseBuild)' == 'true' ">WINGET_ENABLE_RELEASE_BUILD;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <PreprocessorDefinitions Condition=" '$(UseProdCLSIDs)' == 'true' ">USE_PROD_CLSIDS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <PreprocessorDefinitions Condition=" '$(UseProdWingetServer)' == 'true' ">USE_PROD_WINGET_SERVER;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <WarningLevel>Level4</WarningLevel>
          <AdditionalOptions>%(AdditionalOptions) /bigobj /D _SILENCE_CXX17_ITERATOR_BASE_CLASS_DEPRECATION_WARNING</AdditionalOptions>
          <TreatWarningAsError>true</TreatWarningAsError>
          <LanguageStandard>stdcpp17</LanguageStandard>
          <!-- Enable Native Code Analysis -->
          <!-- <EnablePREfast>true</EnablePREfast> -->
          <!-- Disables non-standards conforming code -->
          <ConformanceMode>true</ConformanceMode>
          <!-- SDLCheck is required by BinSkim -->
          <!-- <SDLCheck>true</SDLCheck> -->
        </ClCompile>
        <Link>
          <SubSystem>Console</SubSystem>
          <GenerateWindowsMetadata>false</GenerateWindowsMetadata>
          <!-- CETCompat is required by BinSkim -->
          <!-- <CETCompat>true</CETCompat> -->
        </Link>
      </ItemDefinitionGroup>
      <ItemDefinitionGroup Condition=" '$(Platform)' == 'Win32' ">
        <ClCompile>
          <PreprocessorDefinitions>WIN32;%(PreprocessorDefinitions)</PreprocessorDefinitions>
        </ClCompile>
      </ItemDefinitionGroup>
      <ItemDefinitionGroup Condition=" '$(Configuration)' == 'Release' Or '$(Configuration)' == 'ReleaseStatic' ">
        <ClCompile>
          <Optimization>MaxSpeed</Optimization>
          <FunctionLevelLinking>true</FunctionLevelLinking>
          <IntrinsicFunctions>true</IntrinsicFunctions>
          <PreprocessorDefinitions>NDEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <RuntimeLibrary Condition=" '$(Configuration)' == 'ReleaseStatic' ">MultiThreaded</RuntimeLibrary>
          <!-- Control Flow Guard is required by BinSkim -->
          <ControlFlowGuard>Guard</ControlFlowGuard>
        </ClCompile>
        <Link>
          <EnableCOMDATFolding>true</EnableCOMDATFolding>
          <OptimizeReferences>true</OptimizeReferences>
          <AdditionalOptions>/debug:full /debugtype:cv,fixup /incremental:no %(AdditionalOptions)</AdditionalOptions>
        </Link>
      </ItemDefinitionGroup>
      <ItemDefinitionGroup Condition=" '$(Configuration)' == 'Debug' ">
        <ClCompile>
          <Optimization>Disabled</Optimization>
          <PreprocessorDefinitions>_DEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
          <ControlFlowGuard>false</ControlFlowGuard>
        </ClCompile>
      </ItemDefinitionGroup>
      <ItemDefinitionGroup Condition=" '$(Configuration)' == 'Fuzzing' ">
        <ClCompile>
          <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
          <AdditionalOptions>%(AdditionalOptions) /fsanitize-coverage=inline-8bit-counters /fsanitize-coverage=edge /fsanitize-coverage=trace-cmp /fsanitize-coverage=trace-div</AdditionalOptions>
        </ClCompile>
      </ItemDefinitionGroup>
    </Otherwise>
  </Choose>
</Project>